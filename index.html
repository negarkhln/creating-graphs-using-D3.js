<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>گراف شبکه با D3.js</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #f3f3f3;
      }
      svg {
        width: 100vw;
        height: 100vh;
      }
      circle {
        fill: #ce6abd;
        stroke: #333;
        stroke-width: 1.5px;
      }
      line {
        stroke: #999;
        stroke-opacity: 0.6;
      }
      text {
        font: 14px sans-serif;
        pointer-events: none;
        fill: #333;
      }
      .graph-icon {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <svg></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const svg = d3.select("svg");
      const width = window.innerWidth;
      const height = window.innerHeight;

      d3.json("graph.json").then(function (graph) {
        const simulation = d3
          .forceSimulation(graph.nodes)
          .force(
            "link",
            d3
              .forceLink(graph.links)
              .id((d) => d.id)
              .distance(120)
          )
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg
          .append("g")
          .attr("stroke", "#999")
          .attr("stroke-opacity", 0.6)
          .selectAll("line")
          .data(graph.links)
          .join("line")
          .attr("stroke-width", 2);

        const node = svg
          .append("g")
          .selectAll("g")
          .data(graph.nodes)
          .enter()
          .append("g")
          .attr("class", "node")
          .call(drag(simulation));

        // دایره پس‌زمینه
        node
          .append("circle")
          .attr("r", 20)
          .attr("fill", "#ce6abd")
          .attr("stroke", "#333")
          .attr("stroke-width", 1.5);

        // آیکون به‌صورت متن
        node
          .append("foreignObject")
          .attr("width", 40)
          .attr("height", 40)
          .attr("x", -20)
          .attr("y", -20)
          .append("xhtml:div")
          .html(
            (d) =>
              `<i class="${d.icon} graph-icon" style="font-size:20px; color:white;"></i>`
          );

        //        const label = svg
        //          .append("g")
        //          .selectAll("text")
        //          .data(graph.nodes)
        //          .join("text")
        //          .text((d) => d.id)
        //          .attr("dy", 4)
        //          .attr("dx", -5);

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);

          label.attr("x", (d) => d.x).attr("y", (d) => d.y);
        });

        function drag(simulation) {
          return d3
            .drag()
            .on("start", (event, d) => {
              if (!event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
            })
            .on("drag", (event, d) => {
              d.fx = event.x;
              d.fy = event.y;
            })
            .on("end", (event, d) => {
              if (!event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
            });
        }
      });
    </script>
  </body>
</html>
