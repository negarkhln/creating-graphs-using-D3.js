<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>گراف شبکه با D3.js</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #f3f3f3;
      }
      svg {
        width: 100vw;
        height: 100vh;
      }
      circle {
        fill: #ce6abd;
        stroke: #333;
        stroke-width: 1.5px;
      }
      line {
        stroke: #999;
        stroke-opacity: 0.6;
      }
      text {
        font: 14px sans-serif;
        pointer-events: none;
        fill: #333;
      }
      .graph-icon {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
      }
    </style>
  </head>
  <body>
    <svg></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const svg = d3.select("svg");
      const width = window.innerWidth;
      const height = window.innerHeight;

      d3.json("graph.json").then(function (graph) {
        graph.nodes.forEach((n) => {
          if (!n.group) n.group = "0";
          if (!n.x) n.x = width / 2;
          if (!n.y) n.y = height / 2;
        });

        const clusters = d3.group(graph.nodes, (d) => d.group);

        const simulation = d3
          .forceSimulation(graph.nodes)
          .force(
            "link",
            d3
              .forceLink(graph.links)
              .id((d) => d.id)
              .distance(120)
          )
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg
          .append("g")
          .attr("stroke", "#999")
          .attr("stroke-opacity", 0.6)
          .selectAll("line")
          .data(graph.links)
          .join("line")
          .attr("stroke-width", 2);

        const clusterCircles = svg
          .insert("g", ":first-child")
          .selectAll("circle")
          .data([...clusters.values()])
          .join("circle")
          .attr("fill", (d, i) => (i === 0 ? "lightblue" : "lightgreen"))
          .attr("opacity", 0.2);

        const node = svg
          .append("g")
          .selectAll("g")
          .data(graph.nodes)
          .enter()
          .append("g")
          .attr("class", "node")
          .call(drag(simulation));

        node
          .append("circle")
          .attr("r", 20)
          .attr("fill", "#ce6abd")
          .attr("stroke", "#333")
          .attr("stroke-width", 1.5);

        node
          .append("foreignObject")
          .attr("width", 40)
          .attr("height", 40)
          .attr("x", -20)
          .attr("y", -20)
          .append("xhtml:div")
          .html(
            (d) =>
              `<i class="${d.icon} graph-icon" style="font-size:20px; color:white;"></i>`
          );

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);

          clusterCircles
            .attr("cx", (d3Cluster) => d3.mean(d3Cluster, (n) => n.x))
            .attr("cy", (d3Cluster) => d3.mean(d3Cluster, (n) => n.y))
            .attr("r", (d3Cluster) => {
              const cx = d3.mean(d3Cluster, (n) => n.x);
              const cy = d3.mean(d3Cluster, (n) => n.y);
              return (
                d3.max(d3Cluster, (n) => Math.hypot(n.x - cx, n.y - cy)) + 30
              );
            });
        });

        function drag(simulation) {
          return d3
            .drag()
            .on("start", (event, d) => {
              if (!event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
            })
            .on("drag", (event, d) => {
              d.fx = event.x;
              d.fy = event.y;
            })
            .on("end", (event, d) => {
              if (!event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
            });
        }
      });
    </script>
  </body>
</html>
